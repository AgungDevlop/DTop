<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hilltop Ads Analytics</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 w-full max-w-4xl">
        <h1 class="text-3xl font-bold mb-6 text-gray-800 text-center">Laporan Penghasilan Iklan</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <label for="zone-ids" class="block text-sm font-medium text-gray-700 mb-1">Zone ID</label>
                <input type="text" id="zone-ids" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Pisahkan dengan koma">
                <p class="mt-2 text-xs text-gray-500">Contoh: 4843838,4845176</p>
            </div>
            <div>
                <label for="date-filter" class="block text-sm font-medium text-gray-700 mb-1">Pilih Tanggal</label>
                <input type="date" id="date-filter" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                 <p class="mt-2 text-xs text-gray-500">Kosongkan untuk tanggal hari ini.</p>
            </div>
        </div>

        <button id="fetch-data-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out mb-6">
            Ambil Data
        </button>

        <div id="loading-spinner" class="hidden text-center my-4">
             <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"></div>
            <p class="text-gray-600 mt-2">Memuat data...</p>
        </div>

        <!-- Tabel hasil -->
        <div class="overflow-x-auto">
            <h2 id="analytics-title" class="text-2xl font-semibold my-4 text-gray-700">Analytics</h2>
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Zone ID</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CPM (RP)</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Impressions</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pendapatan (RP)</th>
                    </tr>
                </thead>
                <tbody id="table-data" class="bg-white divide-y divide-gray-200">
                    <!-- Data dari JavaScript akan dimasukkan di sini -->
                </tbody>
            </table>
        </div>

        <!-- Total Pendapatan -->
        <div class="mt-6 text-right">
             <h2 id="total-revenue-title" class="text-xl font-semibold text-gray-800 inline">Total Pendapatan: </h2>
             <span id="total-revenue" class="text-xl font-bold text-indigo-600">Rp 0</span>
        </div>
    </div>

    <script>
        document.getElementById('fetch-data-btn').addEventListener('click', () => {
            const zoneIdsInput = document.getElementById('zone-ids').value;
            const dateValue = document.getElementById('date-filter').value;
            const loadingSpinner = document.getElementById('loading-spinner');
            const tableBody = document.getElementById('table-data');
            const totalRevenueEl = document.getElementById('total-revenue');
            const analyticsTitle = document.getElementById('analytics-title');
            const totalRevenueTitle = document.getElementById('total-revenue-title');

            const zoneIds = zoneIdsInput.split(',').map(id => id.trim()).filter(id => id);

            if (zoneIds.length === 0) {
                alert('Silakan masukkan setidaknya satu Zone ID.');
                return;
            }

            // Dapatkan tanggal dalam format YYYY-MM-DD untuk API
            const apiDate = dateValue || new Date().toISOString().slice(0, 10);

            // ---- PERUBAHAN UTAMA: Buat format tanggal untuk ditampilkan ke pengguna ----
            const dateParts = apiDate.split('-'); // Hasil: ["YYYY", "MM", "DD"]
            const displayDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`; // Hasil: "DD/MM/YYYY"

            // Reset tampilan
            tableBody.innerHTML = '';
            totalRevenueEl.textContent = 'Rp 0';
            loadingSpinner.classList.remove('hidden');

            // Gunakan format displayDate untuk judul
            analyticsTitle.textContent = `Analytics Tanggal ${displayDate}`;
            totalRevenueTitle.textContent = `Total Pendapatan Tanggal ${displayDate}: `;


            const apiKey = 'FEuvZwmnwqc7n44z3C0Kcr56GDuclQg7pMlPDeR0JVhXfX2bMP80Q8hM92k5yRzx';
            const usdToIdrExchangeRate = 15500;

            const createApiUrl = (zoneId, date) => `https://hilltopads.com/api/publisher/listStats?key=${apiKey}&date=${date}&geo=ID&zoneId=${zoneId}`;

            let totalRevenue = 0;
            const fetchPromises = [];

            const fetchData = (apiUrl, zoneId, dateForApi, dateForDisplay) => {
                return fetch(apiUrl)
                    .then(response => response.json())
                    .then(data => {
                        const dateKey = `${dateForApi} 00:00:00`;
                        if (data.status === 'success' && data.result[dateKey] && data.result[dateKey]['']) {
                            const result = data.result[dateKey][''][0];
                            const revenueInIdr = parseFloat(result.revenue) * usdToIdrExchangeRate;
                            totalRevenue += revenueInIdr;

                            // Gunakan format dateForDisplay untuk kolom tanggal di tabel
                            const row = `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${zoneId}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${dateForDisplay}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${(parseFloat(result.cpm) * usdToIdrExchangeRate).toLocaleString('id-ID')}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${parseInt(result.impressions).toLocaleString('id-ID')}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-800">${revenueInIdr.toLocaleString('id-ID', { style: 'currency', currency: 'IDR' })}</td>
                                </tr>
                            `;
                            tableBody.innerHTML += row;
                        } else {
                             const row = `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${zoneId}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${dateForDisplay}</td>
                                    <td colspan="3" class="px-6 py-4 text-center text-sm text-red-500">Gagal memuat atau tidak ada data</td>
                                </tr>
                            `;
                            tableBody.innerHTML += row;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching data for Zone ID:', zoneId, error);
                         const row = `
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${zoneId}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${dateForDisplay}</td>
                                    <td colspan="3" class="px-6 py-4 text-center text-sm text-red-500">Terjadi kesalahan jaringan</td>
                                </tr>
                            `;
                        tableBody.innerHTML += row;
                    });
            };

            zoneIds.forEach(zoneId => {
                // Kirim kedua format tanggal ke fungsi fetch
                fetchPromises.push(fetchData(createApiUrl(zoneId, apiDate), zoneId, apiDate, displayDate));
            });

            Promise.all(fetchPromises).then(() => {
                totalRevenueEl.textContent = totalRevenue.toLocaleString('id-ID', { style: 'currency', currency: 'IDR' });
                loadingSpinner.classList.add('hidden');
            });
        });
    </script>
</body>
</html>
